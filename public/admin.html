<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 페이지</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f9f9f9; margin: 0; }
        .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); padding: 32px; }
        h1 { color: #b51f5a; text-align: center; margin-bottom: 32px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 32px; }
        th, td { border: 1px solid #eee; padding: 8px 10px; text-align: left; }
        th { background: #ffe4ef; color: #b51f5a; }
        tr:nth-child(even) { background: #faf6fa; }
        button { background: #b51f5a; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        button:hover { background: #9c1a4d; }
        .section-title { margin-top: 40px; color: #b51f5a; font-size: 1.1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>관리자 페이지</h1>
        <form id="loginForm" style="max-width:340px;margin:40px auto 32px auto;padding:24px 18px;background:#faf6fa;border-radius:8px;box-shadow:0 2px 8px #eee;display:none;">
            <div style="color:#b51f5a;font-weight:600;font-size:1.1rem;margin-bottom:12px;">관리자 로그인</div>
            <input type="password" id="adminPw" placeholder="비밀번호" style="width:100%;padding:10px;font-size:1rem;border:1px solid #eee;border-radius:5px;margin-bottom:14px;" required />
            <button type="submit" style="width:100%;background:#b51f5a;color:#fff;padding:10px 0;font-size:1rem;border:none;border-radius:5px;font-weight:600;">로그인</button>
            <div id="loginMsg" style="color:#f55;margin-top:10px;font-size:0.97rem;"></div>
        </form>
        <div id="adminContent" style="display:none;">
            <button id="logoutBtn" style="float:right;margin-bottom:18px;background:#eee;color:#b51f5a;">로그아웃</button>
            <div class="section-title">게시글 관리</div>
            <table id="postTable">
                <thead>
                    <tr><th>번호</th><th>작성자</th><th>내용</th><th>작성일</th><th>삭제</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="section-title">사전정보등록 글 관리</div>
            <table id="infoTable">
                <thead>
                    <tr><th>번호</th><th>작성자</th><th>내용</th><th>작성일</th><th>삭제</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
    // 인증 상태 확인
    async function checkAuth() {
        // 인증 여부는 삭제 요청 시 401로 판단, 최초엔 로그인 폼 노출
        document.getElementById('loginForm').style.display = '';
        document.getElementById('adminContent').style.display = 'none';
    }

    async function loadPosts() {
        const res = await fetch('http://localhost:4000/api/posts', { credentials: 'include' });
        const posts = await res.json();
        const tbody = document.querySelector('#postTable tbody');
        tbody.innerHTML = '';
        posts.forEach((post, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${posts.length - idx}</td>
                <td>${post.writer}</td>
                <td>${post.content.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</td>
                <td>${post.created_at}</td>
                <td><button onclick="deletePost(${post.id})">삭제</button></td>
            `;
            tbody.appendChild(tr);
        });
    }
    async function deletePost(id) {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        const res = await fetch('http://localhost:4000/api/posts/' + id, { method: 'DELETE', credentials: 'include' });
        if (res.status === 401) {
            alert('관리자 인증이 필요합니다.');
            showLogin();
            return;
        }
        loadPosts();
    }
 async function loadInfo() {
    const res = await fetch('http://localhost:4000/api/info', { credentials: 'include' });
    const infos = await res.json();
    const tbody = document.querySelector('#infoTable tbody');
    tbody.innerHTML = '';
    infos.forEach((info, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${infos.length - idx}</td>
            <td>${info.name}</td>
            <td>
                연락처: ${info.phone}<br>
                이메일: ${info.email}
            </td>
            <td>${info.created_at ? info.created_at.split('T')[0] : ''}</td>
            <td><button onclick="deleteInfo(${info.id})">삭제</button></td>
        `;
        tbody.appendChild(tr);
    });
}
    async function deleteInfo(id) {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        const res = await fetch('http://localhost:4000/api/info/' + id, { method: 'DELETE', credentials: 'include' });
        if (res.status === 401) {
            alert('관리자 인증이 필요합니다.');
            showLogin();
            return;
        }
        loadInfo();
    }

    // 로그인 폼 처리
    function showLogin() {
        document.getElementById('loginForm').style.display = '';
        document.getElementById('adminContent').style.display = 'none';
    }
    function showAdmin() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('adminContent').style.display = '';
        loadPosts();
        loadInfo();
    }
    document.getElementById('loginForm').onsubmit = async function(e) {
        e.preventDefault();
        const pw = document.getElementById('adminPw').value;
        const res = await fetch('http://localhost:4000/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw }),
            credentials: 'include'
        });
        if (res.ok) {
            showAdmin();
        } else {
            document.getElementById('loginMsg').textContent = '비밀번호가 틀렸습니다.';
        }
    };
    document.getElementById('logoutBtn').onclick = async function() {
        await fetch('http://localhost:4000/api/admin/logout', { method: 'POST', credentials: 'include' });
     // 공개게시판 팝업 닫기 (id 맞게 변경!!)
    const popup = document.getElementById('publicBoardPopup');
    if (popup) popup.style.display = 'none';
        // 로그아웃 후 메인페이지로 이동
        window.location.href = 'index.html';
    };
    // 최초 진입 시 로그인 폼 노출
    showLogin();
    </script>
</body>
</html>
