<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공개게시판</title>
    <style>
                .pagination { display: flex; gap: 6px; justify-content: center; margin: 18px 0 0 0; }
                .pagination button { background: #fff; border: 1px solid #b51f5a; color: #b51f5a; border-radius: 4px; padding: 4px 13px; font-size: 1rem; cursor: pointer; transition: background 0.2s, color 0.2s; }
                .pagination button.active, .pagination button:hover { background: #b51f5a; color: #fff; }
            .comment-section { margin-top: 12px; padding-left: 12px; }
            .comment-list { list-style: none; padding: 0; margin: 0 0 8px 0; }
            .comment-list li { font-size: 0.97rem; color: #444; background: #f7f7fa; border-radius: 6px; margin-bottom: 4px; padding: 7px 12px; }
            .comment-form { display: flex; gap: 6px; margin-top: 6px; }
            .comment-form input { flex: 0 0 80px; padding: 5px 8px; border: 1px solid #eee; border-radius: 4px; font-size: 0.97rem; }
            .comment-form textarea { flex: 1; padding: 5px 8px; border: 1px solid #eee; border-radius: 4px; font-size: 0.97rem; resize: vertical; min-height: 28px; }
            .comment-form button { background: #b51f5a; color: #fff; border: none; border-radius: 4px; padding: 6px 16px; font-size: 0.97rem; font-weight: 500; cursor: pointer; }
            .comment-form button:hover { background: #9c1a4d; }
        body { font-family: 'Pretendard', sans-serif; background: #f9f9f9; margin: 0; }
        .container { max-width: 800px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); padding: 32px; }
        h1 { color: #b51f5a; text-align: center; margin-bottom: 32px; }
        .notice { background: #ffe4ef; color: #b51f5a; padding: 16px; border-radius: 8px; margin-bottom: 24px; text-align: center; }
        .write-btn { display: block; margin: 0 0 24px auto; background: #b51f5a; color: #fff; border: none; border-radius: 6px; padding: 12px 28px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .write-btn:hover { background: #9c1a4d; }
        .post-list { list-style: none; padding: 0; }
        .post-list li { border-bottom: 1px solid #eee; padding: 10px 0 8px 0; min-height: 38px; }
        .post-list li:last-child { border-bottom: none; }
        .post-title { font-weight: 500; color: #222; font-size: 0.98rem; line-height: 1.4; }
        .post-meta { color: #888; font-size: 0.85rem; margin-top: 2px; }
        .comment-btn { margin-top: 6px; font-size: 0.92rem; padding: 4px 13px; }
        .comment-section { margin-top: 7px; padding-left: 8px; }
        .comment-list li { font-size: 0.92rem; padding: 5px 10px; }
        .comment-form input, .comment-form textarea { font-size: 0.92rem; padding: 4px 7px; }
        .comment-btn { margin-top: 10px; background: #ffe4ef; color: #b51f5a; border: none; border-radius: 4px; padding: 6px 18px; font-size: 0.97rem; font-weight: 500; cursor: pointer; transition: background 0.2s; }
        .comment-btn:hover { background: #f9c2d6; }
        /* 글쓰기 모달 */
        .modal-bg { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.25); }
        .modal-bg.active { display: block; }
        .write-modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%); background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); padding: 32px 28px 24px 28px; min-width: 320px; max-width: 90vw; z-index: 1100; }
        .write-modal h2 { color: #b51f5a; font-size: 1.3rem; margin-bottom: 18px; text-align: center; }
        .write-modal label { display: block; margin-bottom: 6px; font-weight: 500; }
        .write-modal input, .write-modal textarea { width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 16px; font-size: 1rem; }
        .write-modal textarea { min-height: 80px; resize: vertical; }
        .modal-btns { display: flex; gap: 12px; justify-content: flex-end; }
        .modal-btns button { padding: 8px 22px; border: none; border-radius: 5px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .modal-btns .cancel { background: #eee; color: #888; }
        .modal-btns .submit { background: #b51f5a; color: #fff; }
        .modal-btns .submit:hover { background: #9c1a4d; }
    </style>
</head>
<body>
    <div class="modal-bg" id="modalBg">
        <div class="write-modal" id="writeModal">
            <h2>글쓰기</h2>
            <form id="writeForm" autocomplete="off">
                <label for="writer">작성자</label>
                <input type="text" id="writer" name="writer" maxlength="12" required>
                <label for="content">내용</label>
                <textarea id="content" name="content" maxlength="300" required></textarea>
                <div class="modal-btns">
                    <button type="button" class="cancel" id="cancelBtn">취소</button>
                    <button type="submit" class="submit">등록</button>
                </div>
            </form>
        </div>
    </div>
    <div class="container">
        <h1>공개게시판</h1>
        <button class="write-btn" id="openWriteBtn">글쓰기</button>
        <div class="notice">이곳은 조합원 및 방문객 누구나 자유롭게 의견을 남길 수 있는 공간입니다.<br>
        비방글이나 근거없는 게시글로 제3자에게 피해를 주는 글은 예고 없이 삭제 됩니다</div>
        <ul class="post-list" id="postList">
            <li style="text-align:center;color:#aaa;">불러오는 중...</li>
        </ul>
    </div>
    <footer style="text-align:center; margin:40px 0 10px 0; color:#aaa; font-size:0.97rem;">
        <a href="admin.html" style="color:#b51f5a; text-decoration:underline; font-weight:500;">관리자 페이지</a>
    </footer>
    <script>
    // 글쓰기 모달 열기/닫기
    const openBtn = document.getElementById('openWriteBtn');
    const modalBg = document.getElementById('modalBg');
    const cancelBtn = document.getElementById('cancelBtn');
    const writeForm = document.getElementById('writeForm');
    const postList = document.getElementById('postList');
    openBtn.onclick = () => { modalBg.classList.add('active'); document.getElementById('writer').focus(); };
    cancelBtn.onclick = () => { modalBg.classList.remove('active'); writeForm.reset(); };
    modalBg.onclick = e => { if(e.target === modalBg) { modalBg.classList.remove('active'); writeForm.reset(); } };

    // 게시글 목록 불러오기 (페이지네이션)
    async function loadPosts() {
        postList.innerHTML = '<li style="text-align:center;color:#aaa;">불러오는 중...</li>';
        try {
            const res = await fetch('http://localhost:4000/api/posts');
            const posts = await res.json();
            window._allPosts = posts;
            renderPage(1);
        } catch (e) {
            postList.innerHTML = '<li style="text-align:center;color:#f55;">서버 연결 오류</li>';
        }
    }
    loadPosts();

    // 페이지네이션 렌더링 및 게시글 표시
    function renderPage(page) {
        const posts = window._allPosts || [];
        const perPage = 10;
        const total = posts.length;
        const totalPages = Math.ceil(total / perPage);
        if (!total) {
            postList.innerHTML = '<li style="text-align:center;color:#aaa;">아직 게시글이 없습니다.</li>';
            document.getElementById('pagination')?.remove();
            return;
        }
        postList.innerHTML = '';
        const start = (page-1)*perPage;
        const end = Math.min(start+perPage, total);
        for (let i=start; i<end; ++i) {
            const post = posts[i];
            const li = document.createElement('li');
            // 최신글이 1번이 되도록 역순 번호
            const postNumber = total - i;
            li.innerHTML = `
                <span style="display:inline-block;min-width:2.2em;color:#b51f5a;font-weight:600;font-size:0.95em;vertical-align:top;">${postNumber}</span>
                <div class="post-title" style="display:inline;">${post.content.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div><br>
                <div class="post-meta">${post.writer} · ${post.created_at}</div>
                <button class="comment-btn">댓글</button>
                <div class="comment-section" style="display:none;"></div>
            `;
            postList.appendChild(li);
        }
        // 페이지네이션
        let pag = document.getElementById('pagination');
        if (!pag) {
            pag = document.createElement('div');
            pag.id = 'pagination';
            postList.parentNode.appendChild(pag);
        }
        pag.className = 'pagination';
        pag.innerHTML = '';
        for (let i=1; i<=totalPages; ++i) {
            const btn = document.createElement('button');
            btn.textContent = i;
            if (i === page) btn.classList.add('active');
            btn.onclick = () => renderPage(i);
            pag.appendChild(btn);
        }
    }

    // 댓글 기능 (프론트엔드 메모리)
    let commentData = {};

    // 댓글 버튼 이벤트 위임
    postList.addEventListener('click', function(e) {
        if (e.target.classList.contains('comment-btn')) {
            const li = e.target.closest('li');
            const section = li.querySelector('.comment-section');
            // 이미 열려있으면 닫기
            if (section.style.display === 'block') {
                section.style.display = 'none';
                section.innerHTML = '';
                return;
            }
            // 열기 및 폼 렌더링
            section.style.display = 'block';
            const idx = Array.from(postList.children).indexOf(li) + (window._currentPage ? (window._currentPage-1)*10 : 0);
            const comments = commentData[idx] || [];
            section.innerHTML = `
                <ul class="comment-list">${comments.map(c => `<li><b>${c.writer}</b>: ${c.text}</li>`).join('')}</ul>
                <form class="comment-form">
                    <input type="text" name="writer" placeholder="작성자" maxlength="10" required />
                    <textarea name="text" placeholder="댓글 입력" maxlength="100" required></textarea>
                    <button type="submit">등록</button>
                </form>
            `;
        }
    });

    // 댓글 등록 이벤트 위임
    postList.addEventListener('submit', function(e) {
        if (e.target.classList.contains('comment-form')) {
            e.preventDefault();
            const form = e.target;
            const li = form.closest('li');
            const section = li.querySelector('.comment-section');
            const idx = Array.from(postList.children).indexOf(li) + (window._currentPage ? (window._currentPage-1)*10 : 0);
            const writer = form.writer.value.trim() || '익명';
            const text = form.text.value.trim();
            if (!text) return;
            if (!commentData[idx]) commentData[idx] = [];
            commentData[idx].push({ writer, text });
            // 폼 리렌더링
            section.innerHTML = `
                <ul class="comment-list">${commentData[idx].map(c => `<li><b>${c.writer}</b>: ${c.text}</li>`).join('')}</ul>
                <form class="comment-form">
                    <input type="text" name="writer" placeholder="작성자" maxlength="10" required />
                    <textarea name="text" placeholder="댓글 입력" maxlength="100" required></textarea>
                    <button type="submit">등록</button>
                </form>
            `;
        }
    });
    </script>
</body>
<script>
// 글쓰기 모달 열기/닫기
const openBtn = document.getElementById('openWriteBtn');
const modalBg = document.getElementById('modalBg');
const cancelBtn = document.getElementById('cancelBtn');
const writeForm = document.getElementById('writeForm');
const postList = document.getElementById('postList');
openBtn.onclick = () => { modalBg.classList.add('active'); document.getElementById('writer').focus(); };
cancelBtn.onclick = () => { modalBg.classList.remove('active'); writeForm.reset(); };
modalBg.onclick = e => { if(e.target === modalBg) { modalBg.classList.remove('active'); writeForm.reset(); } };

// 게시글 목록 불러오기
async function loadPosts() {
    postList.innerHTML = '<li style="text-align:center;color:#aaa;">불러오는 중...</li>';
    try {
        const res = await fetch('http://localhost:4000/api/posts');
        const posts = await res.json();
        window._allPosts = posts;
        renderPage(1);
    } catch (e) {
        postList.innerHTML = '<li style="text-align:center;color:#f55;">서버 연결 오류</li>';
    }

// 페이지네이션 렌더링 및 게시글 표시
function renderPage(page) {
    const posts = window._allPosts || [];
    const perPage = 10;
    const total = posts.length;
    const totalPages = Math.ceil(total / perPage);
    if (!total) {
        postList.innerHTML = '<li style="text-align:center;color:#aaa;">아직 게시글이 없습니다.</li>';
        document.getElementById('pagination')?.remove();
        return;
    }
    postList.innerHTML = '';
    const start = (page-1)*perPage;
    const end = Math.min(start+perPage, total);
    for (let i=start; i<end; ++i) {
        const post = posts[i];
        const li = document.createElement('li');
        // 전체 게시글에서 최신글이 1번이 되도록 역순 번호
        const postNumber = total - i;
        li.innerHTML = `
            <span style="display:inline-block;min-width:2.2em;color:#b51f5a;font-weight:600;font-size:0.95em;vertical-align:top;">${postNumber}</span>
            <div class="post-title" style="display:inline;">${post.content.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div><br>
            <div class="post-meta">${post.writer} · ${post.created_at}</div>
            <button class="comment-btn">댓글</button>
            <div class="comment-section" style="display:none;"></div>
        `;
        postList.appendChild(li);
    }
    // 페이지네이션
    let pag = document.getElementById('pagination');
    if (!pag) {
        pag = document.createElement('div');
        pag.id = 'pagination';
        postList.parentNode.appendChild(pag);
    }
    pag.className = 'pagination';
    pag.innerHTML = '';
    for (let i=1; i<=totalPages; ++i) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === page) btn.classList.add('active');
        btn.onclick = () => renderPage(i);
        pag.appendChild(btn);
    }
}
}
loadPosts();

// 댓글 기능 (프론트엔드 메모리)
let commentData = {};

// 댓글 버튼 이벤트 위임
postList.addEventListener('click', function(e) {
    if (e.target.classList.contains('comment-btn')) {
        const li = e.target.closest('li');
        const section = li.querySelector('.comment-section');
        // 이미 열려있으면 닫기
        if (section.style.display === 'block') {
            section.style.display = 'none';
            section.innerHTML = '';
            return;
        }
        // 열기 및 폼 렌더링
        section.style.display = 'block';
        const idx = Array.from(postList.children).indexOf(li);
        const comments = commentData[idx] || [];
        section.innerHTML = `
            <ul class="comment-list">${comments.map(c => `<li><b>${c.writer}</b>: ${c.text}</li>`).join('')}</ul>
            <form class="comment-form">
                <input type="text" name="writer" placeholder="작성자" maxlength="10" required />
                <textarea name="text" placeholder="댓글 입력" maxlength="100" required></textarea>
                <button type="submit">등록</button>
            </form>
        `;
    }
});

// 댓글 등록 이벤트 위임
postList.addEventListener('submit', function(e) {
    if (e.target.classList.contains('comment-form')) {
        e.preventDefault();
        const form = e.target;
        const li = form.closest('li');
        const section = li.querySelector('.comment-section');
        const idx = Array.from(postList.children).indexOf(li);
        const writer = form.writer.value.trim() || '익명';
        const text = form.text.value.trim();
        if (!text) return;
        if (!commentData[idx]) commentData[idx] = [];
        commentData[idx].push({ writer, text });
        // 폼 리렌더링
        section.innerHTML = `
            <ul class="comment-list">${commentData[idx].map(c => `<li><b>${c.writer}</b>: ${c.text}</li>`).join('')}</ul>
            <form class="comment-form">
                <input type="text" name="writer" placeholder="작성자" maxlength="10" required />
                <textarea name="text" placeholder="댓글 입력" maxlength="100" required></textarea>
                <button type="submit">등록</button>
            </form>
        `;
    }
});

// 글쓰기 등록
writeForm.onsubmit = async e => {
    e.preventDefault();
    const writer = document.getElementById('writer').value.trim() || '익명';
    const content = document.getElementById('content').value.trim();
    if (!content) {
        alert('내용을 입력해 주세요.');
        return;
    }
    try {
        const res = await fetch('http://localhost:4000/api/posts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ writer, content })
        });
        if (!res.ok) throw new Error('등록 실패');
        modalBg.classList.remove('active');
        writeForm.reset();
        loadPosts();
    } catch (e) {
        alert('글 등록에 실패했습니다.');
    }
};
</script>
</html>